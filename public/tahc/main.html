<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JMW Chat</title>
  <link rel="icon" href="/assets/images/jmw.png" />
  <link rel="shortcut icon" href="/assets/images/jmw.png" />
  <link rel="stylesheet" href="/assets/css/chat.css" />
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>

<body theme="classic">
  <header>
    <button id="toggleUsers" class="btn ghost"><i style="font-size:25px;" class='bx bx-group'></i></button>
    <h1>JMW Chat</h1>
    <div class="spacer"></div>
    <button id="startDmBtn" class="btn">Start DM</button>
    <button id="createGroupBtn" class="btn">Create Group</button>
    <button id="changeNameBtn" class="btn secondary">Change Username</button>
    <button id="adminPanelBtn" class="btn" style="display:none;">Admin Panel</button>
    <button id="adminKeyBtn" class="btn">Admin Key</button>
  </header>
  <div class="layout">
    <aside id="usersPanel" class="users-panel">
      <header>Users</header>
      <div id="usersList" class="users-list"></div>
    </aside>
    <div class="main">
      <aside class="sidebar">
        <div class="side-section">
          <div class="side-title">Public</div>
          <button id="publicBtn" class="room-btn">General Chat</button>
        </div>
        <div class="side-section">
          <div class="side-title">Private Direct Messages</div>
          <div id="myChats" class="room-list"></div>
        </div>
      </aside>
      <section class="chat">
        <div id="chatTitle" class="chat-header">
          Public Chat
          <button id="renameGroupBtn" class="btn secondary" style="display:none;">Rename Group</button>
        </div>
        <div id="messages" class="messages"><div id="emojiPicker"></div></div>
        <div class="composer">
          <input id="messageInput" placeholder="Type a messageâ€¦" />
          <button id="sendBtn">Send</button>
        </div>
      </section>
    </div>
  </div>
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header id="modalTitle">Modal</header>
      <div id="modalBody" class="body"></div>
      <div class="footer">
        <button id="modalCancel" class="btn secondary" type="button">Cancel</button>
        <button id="modalSave" class="btn" type="button">Save</button>
      </div>
    </div>
  </div>
  <script type="module" src="/tahc/chat.js"></script>
</body>
<script src="/assets/scripts/index.js"></script>
<script>
  let count = parseInt(localStorage.getItem('alertCount')) || 0;

  if (count < 2) {
    alert(
      "This will only appear 2 times. I usually clear chat with every update. Also, stop trying to get the admin key. I won't give it to you."
      )
    localStorage.setItem('alertCount', count + 1);
  }
</script>
<script>
  // Tenor GIF Integration for Chat App
// Add this script to your HTML after the main chat script

const TENOR_API_KEY = "AIzaSyA24jeIvpbIxYEgUA295eEPIVippIFjN3E";
const TENOR_CLIENT_KEY = "my_chat_app";

// Global GIF state
let gifSearchResults = [];
let currentGifSearch = "";

// Create GIF button and picker UI
function initializeGifPicker() {
  // Create GIF button next to emoji button
  const gifButton = document.createElement('button');
  gifButton.id = 'gifButton';
  gifButton.textContent = 'ðŸŽ¬ GIF';
  gifButton.style.cssText = `
    position: absolute;
    right: 70px;
    bottom: 40px;
    transform: translateY(-50%);
    border: none;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 6px;
    z-index: 99999999999;
    color: white;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    transition: all 0.2s;
  `;

  gifButton.onmouseenter = () => {
    gifButton.style.transform = 'translateY(-50%) scale(1.05)';
    gifButton.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.6)';
  };

  gifButton.onmouseleave = () => {
    gifButton.style.transform = 'translateY(-50%) scale(1)';
    gifButton.style.boxShadow = '0 2px 8px rgba(102, 126, 234, 0.4)';
  };

  // Create GIF picker modal
  const gifPicker = document.createElement('div');
  gifPicker.id = 'gifPicker';
  gifPicker.style.cssText = `
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 450px;
    height: 550px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    display: none;
    flex-direction: column;
    z-index: 99999;
    box-shadow: 0 12px 48px rgba(0,0,0,0.4);
    overflow: hidden;
  `;

  // GIF picker header
  const gifHeader = document.createElement('div');
  gifHeader.style.cssText = `
    padding: 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    flex-direction: column;
    gap: 12px;
  `;

  // Title row
  const titleRow = document.createElement('div');
  titleRow.style.cssText = `
    display: flex;
    align-items: center;
    justify-content: space-between;
  `;

  const gifTitle = document.createElement('div');
  gifTitle.textContent = 'ðŸŽ¬ Choose a GIF';
  gifTitle.style.cssText = `
    font-size: 18px;
    font-weight: bold;
    color: white;
  `;

  const closeGifBtn = document.createElement('button');
  closeGifBtn.textContent = 'âœ•';
  closeGifBtn.style.cssText = `
    border: none;
    background: rgba(255, 255, 255, 0.2);
    font-size: 18px;
    cursor: pointer;
    color: white;
    padding: 4px;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    transition: background 0.2s;
  `;
  closeGifBtn.onmouseenter = () => {
    closeGifBtn.style.background = 'rgba(255, 255, 255, 0.3)';
  };
  closeGifBtn.onmouseleave = () => {
    closeGifBtn.style.background = 'rgba(255, 255, 255, 0.2)';
  };
  closeGifBtn.onclick = () => {
    gifPicker.style.display = 'none';
  };

  titleRow.appendChild(gifTitle);
  titleRow.appendChild(closeGifBtn);

  // Search input
  const gifSearchInput = document.createElement('input');
  gifSearchInput.id = 'gifSearchInput';
  gifSearchInput.placeholder = 'ðŸ” Search GIFs... (e.g., "happy", "cat", "dance")';
  gifSearchInput.style.cssText = `
    width: 100%;
    padding: 10px 14px;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.95);
    color: #333;
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  `;

  // Trending button
  const trendingBtn = document.createElement('button');
  trendingBtn.id = 'trendingBtn';
  trendingBtn.textContent = 'ðŸ”¥ Show Trending GIFs';
  trendingBtn.style.cssText = `
    width: 100%;
    padding: 10px 14px;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  `;
  trendingBtn.onmouseenter = () => {
    trendingBtn.style.background = 'rgba(255, 255, 255, 0.3)';
    trendingBtn.style.transform = 'scale(1.02)';
  };
  trendingBtn.onmouseleave = () => {
    trendingBtn.style.background = 'rgba(255, 255, 255, 0.2)';
    trendingBtn.style.transform = 'scale(1)';
  };
  trendingBtn.onclick = () => {
    gifSearchInput.value = '';
    loadTrendingGifs();
  };

  gifHeader.appendChild(titleRow);
  gifHeader.appendChild(gifSearchInput);
  gifHeader.appendChild(trendingBtn);

  // GIF results container
  const gifResults = document.createElement('div');
  gifResults.id = 'gifResults';
  gifResults.style.cssText = `
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    align-content: start;
    background: var(--bg);
  `;

  // Loading indicator
  const gifLoading = document.createElement('div');
  gifLoading.id = 'gifLoading';
  gifLoading.style.cssText = `
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
    display: none;
  `;
  gifLoading.innerHTML = `
    <div style="width:40px;height:40px;border:4px solid var(--surface-hover);border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px;"></div>
    <div>Loading GIFs...</div>
  `;
  gifResults.appendChild(gifLoading);

  // Add powered by Tenor
  const poweredBy = document.createElement('div');
  poweredBy.style.cssText = `
    padding: 12px;
    text-align: center;
    font-size: 12px;
    color: var(--text-muted);
    border-top: 1px solid var(--border);
    background: var(--surface);
  `;
  poweredBy.innerHTML = 'Powered by <strong>Tenor</strong>';

  gifPicker.appendChild(gifHeader);
  gifPicker.appendChild(gifResults);
  gifPicker.appendChild(poweredBy);

  // Add to DOM
  const inputContainer = document.getElementById('messageInput')?.parentElement;
  if (inputContainer) {
    inputContainer.appendChild(gifButton);
  }
  document.body.appendChild(gifPicker);

  // Event listeners
  gifButton.onclick = () => {
    const isVisible = gifPicker.style.display === 'flex';
    gifPicker.style.display = isVisible ? 'none' : 'flex';
    if (!isVisible) {
      loadTrendingGifs();
      setTimeout(() => gifSearchInput.focus(), 100);
    }
  };

  // Search functionality with debounce
  let searchTimeout;
  gifSearchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim();
    
    if (query.length === 0) {
      // Don't auto-load trending, wait for button click
      return;
    }

    searchTimeout = setTimeout(() => {
      searchGifs(query);
    }, 500);
  });

  // Close when clicking outside
  document.addEventListener('click', (e) => {
    if (!gifPicker.contains(e.target) && e.target !== gifButton) {
      gifPicker.style.display = 'none';
    }
  });

  console.log('âœ… GIF picker initialized!');
}

// Load trending GIFs
async function loadTrendingGifs() {
  const gifResults = document.getElementById('gifResults');
  const gifLoading = document.getElementById('gifLoading');
  
  if (!gifResults || !gifLoading) return;

  gifLoading.style.display = 'block';
  gifResults.querySelectorAll('.gif-item').forEach(item => item.remove());

  try {
    const response = await fetch(
      `https://tenor.googleapis.com/v2/featured?key=${TENOR_API_KEY}&client_key=${TENOR_CLIENT_KEY}&limit=30`
    );
    
    if (!response.ok) throw new Error('Failed to fetch');
    
    const data = await response.json();
    
    gifSearchResults = data.results;
    displayGifs(data.results, 'ðŸ”¥ Trending GIFs');
  } catch (error) {
    console.error('Error loading trending GIFs:', error);
    showGifError('Failed to load trending GIFs. Please try again!');
  } finally {
    gifLoading.style.display = 'none';
  }
}

// Search GIFs
async function searchGifs(query) {
  const gifResults = document.getElementById('gifResults');
  const gifLoading = document.getElementById('gifLoading');
  
  if (!gifResults || !gifLoading) return;

  gifLoading.style.display = 'block';
  gifResults.querySelectorAll('.gif-item').forEach(item => item.remove());
  
  currentGifSearch = query;

  try {
    const response = await fetch(
      `https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(query)}&key=${TENOR_API_KEY}&client_key=${TENOR_CLIENT_KEY}&limit=30`
    );
    
    if (!response.ok) throw new Error('Failed to fetch');
    
    const data = await response.json();
    
    gifSearchResults = data.results;
    displayGifs(data.results, `ðŸ” Results for "${query}"`);
  } catch (error) {
    console.error('Error searching GIFs:', error);
    showGifError('Failed to search GIFs. Please try again!');
  } finally {
    gifLoading.style.display = 'none';
  }
}

// Display GIFs in grid
function displayGifs(gifs, headerText) {
  const gifResults = document.getElementById('gifResults');
  
  if (!gifResults) return;

  // Remove old GIFs
  gifResults.querySelectorAll('.gif-item').forEach(item => item.remove());
  gifResults.querySelectorAll('.gif-header').forEach(item => item.remove());

  // Add header
  const header = document.createElement('div');
  header.className = 'gif-header';
  header.style.cssText = `
    grid-column: 1 / -1;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    padding: 8px 0;
    margin-bottom: 4px;
  `;
  header.textContent = headerText;
  gifResults.appendChild(header);

  if (gifs.length === 0) {
    const noResults = document.createElement('div');
    noResults.className = 'gif-item';
    noResults.style.cssText = `
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    `;
    noResults.textContent = 'ðŸ˜” No GIFs found. Try a different search!';
    gifResults.appendChild(noResults);
    return;
  }

  gifs.forEach(gif => {
    const gifItem = document.createElement('div');
    gifItem.className = 'gif-item';
    gifItem.style.cssText = `
      aspect-ratio: 1;
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      background: var(--surface-hover);
      position: relative;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    `;

    const img = document.createElement('img');
    img.src = gif.media_formats.tinygif.url;
    img.alt = gif.content_description || 'GIF';
    img.style.cssText = `
      width: 100%;
      height: 100%;
      object-fit: cover;
    `;

    gifItem.appendChild(img);

    gifItem.onmouseenter = () => {
      gifItem.style.transform = 'scale(1.05)';
      gifItem.style.boxShadow = '0 4px 16px rgba(102, 126, 234, 0.4)';
    };

    gifItem.onmouseleave = () => {
      gifItem.style.transform = 'scale(1)';
      gifItem.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
    };

    gifItem.onclick = () => {
      insertGifIntoChat(gif);
    };

    gifResults.appendChild(gifItem);
  });
}

// Insert GIF into chat
async function insertGifIntoChat(gif) {
  const messageInput = document.getElementById('messageInput');
  const gifPicker = document.getElementById('gifPicker');
  
  if (!messageInput) return;

  // Get the full size GIF URL
  const gifUrl = gif.media_formats.gif.url;
  const gifId = gif.id;
  
  // Register share (Tenor API requirement)
  registerGifShare(gifId);

  // Insert GIF URL into message
  // Format: [GIF:url]
  const gifText = `[GIF:${gifUrl}]`;
  messageInput.value = gifText;
  
  // Update char count if function exists
  if (window.updateCharCount) {
    window.updateCharCount();
  }

  // Close GIF picker
  if (gifPicker) {
    gifPicker.style.display = 'none';
  }

  // Show success message
  if (window.showStatusMessage) {
    window.showStatusMessage('GIF added! Click send to share it ðŸŽ‰', 'info');
  }

  // Focus on message input
  messageInput.focus();
}

// Register GIF share with Tenor (required by API terms)
async function registerGifShare(gifId) {
  try {
    await fetch(
      `https://tenor.googleapis.com/v2/registershare?id=${gifId}&key=${TENOR_API_KEY}&client_key=${TENOR_CLIENT_KEY}`,
      { method: 'GET' }
    );
  } catch (error) {
    console.error('Error registering GIF share:', error);
  }
}

// Show error message in GIF picker
function showGifError(message) {
  const gifResults = document.getElementById('gifResults');
  
  if (!gifResults) return;

  gifResults.querySelectorAll('.gif-item').forEach(item => item.remove());
  gifResults.querySelectorAll('.gif-header').forEach(item => item.remove());
  
  const errorDiv = document.createElement('div');
  errorDiv.className = 'gif-item';
  errorDiv.style.cssText = `
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px 20px;
    color: #ff4444;
  `;
  errorDiv.textContent = `âŒ ${message}`;
  gifResults.appendChild(errorDiv);
}

// Modified renderMessage function to handle GIFs
// Replace your existing renderMessage function with this one
function renderMessageWithGif(m) {
  const row = document.createElement("div");
  row.className = "bubble" + (m.uid === me.uid ? " me" : "");
  
  const av = document.createElement("div");
  av.className = "avatar";
  av.textContent = avatarLetter(m.name);
  
  const content = document.createElement("div");
  content.className = "content";
  
  const nm = document.createElement("div");
  nm.className = "name";
  const timestamp = formatTimestamp(m.timestamp);
  const safeName = sanitizeInput(m.name || "Unknown", 20);
  const safeTag = sanitizeInput(m.tag || "0000", 10);
  nm.textContent = `${safeUsername(safeName, safeTag)} â€¢ ${timestamp}`;
  
  const tx = document.createElement("div");
  
  // Check if message contains GIF
  const gifPattern = /\[GIF:(https?:\/\/[^\]]+)\]/;
  const gifMatch = m.text.match(gifPattern);
  
  if (gifMatch) {
    const gifUrl = gifMatch[1];
    
    const gifContainer = document.createElement('div');
    gifContainer.style.cssText = `
      margin-top: 8px;
      border-radius: 10px;
      overflow: hidden;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    const gifImg = document.createElement('img');
    gifImg.src = gifUrl;
    gifImg.alt = 'GIF';
    gifImg.style.cssText = `
      width: 100%;
      height: auto;
      display: block;
      cursor: pointer;
      transition: transform 0.2s;
    `;
    
    gifImg.onmouseenter = () => {
      gifImg.style.transform = 'scale(1.02)';
    };
    
    gifImg.onmouseleave = () => {
      gifImg.style.transform = 'scale(1)';
    };
    
    gifImg.onclick = () => {
      window.open(gifUrl, '_blank');
    };
    
    gifContainer.appendChild(gifImg);
    
    // Show text before/after GIF if exists
    const textBefore = m.text.substring(0, gifMatch.index).trim();
    const textAfter = m.text.substring(gifMatch.index + gifMatch[0].length).trim();
    
    if (textBefore) {
      const beforeText = document.createElement('div');
      beforeText.textContent = filterSwearing(sanitizeInput(textBefore, 119));
      beforeText.style.marginBottom = '8px';
      tx.appendChild(beforeText);
    }
    
    tx.appendChild(gifContainer);
    
    if (textAfter) {
      const afterText = document.createElement('div');
      afterText.textContent = filterSwearing(sanitizeInput(textAfter, 119));
      afterText.style.marginTop = '8px';
      tx.appendChild(afterText);
    }
  } else {
    // Regular text message
    const safeText = filterSwearing(sanitizeInput(m.text || "", 119));
    tx.textContent = safeText;
  }
  
  content.appendChild(nm);
  content.appendChild(tx);
  row.appendChild(av);
  row.appendChild(content);
  return row;
}

// Auto-initialize when script loads
(function() {
  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializeGifPicker, 1000);
    });
  } else {
    setTimeout(initializeGifPicker, 1000);
  }
})();

// Export functions
window.initializeGifPicker = initializeGifPicker;
window.renderMessageWithGif = renderMessageWithGif;

console.log('ðŸŽ¬ Tenor GIF Integration loaded! Waiting to initialize...');
</script>
</html>